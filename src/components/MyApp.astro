---
const apiKey = import.meta.env.API_KEY;
const city = "Spokane";

let weather = null;
let errorMessage = null;

try {
  const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=metric`);
  if (!response.ok) {
    throw new Error("Failed to fetch weather data");
  }

  weather = await response.json();
  console.log("Weather Response:", weather);
} catch (error) {
  console.error("Error fetching weather data:", error);
  errorMessage = error.message || "An unexpected error occurred";
}

// Helper function for wind direction
function getWindDirection(deg) {
  const directions = ["N", "NE", "E", "SE", "S", "SW", "W", "NW"];
  const index = Math.round(deg / 45) % 8;
  return directions[index];
}
---

<div class="weather-container">
  {weather ? (
    <>
      <h1>Weather in {weather.name}, {weather.sys.country}</h1>
      <p class="weather-icon">
        <img src={`https://openweathermap.org/img/wn/${weather.weather[0].icon}@2x.png`} alt={weather.weather[0].description} />
      </p>
      <p><strong>Condition:</strong> {weather.weather[0].description || "N/A"}</p>
      <p><strong>Temperature:</strong> {weather.main?.temp?.toFixed(1) || "N/A"}°C</p>
      <p><strong>Feels Like:</strong> {weather.main?.feels_like?.toFixed(1) || "N/A"}°C</p>
      <p><strong>Humidity:</strong> {weather.main?.humidity || "N/A"}%</p>
      <p><strong>Pressure:</strong> {weather.main?.pressure || "N/A"} hPa</p>
      <p><strong>Visibility:</strong> {(weather.visibility / 1000).toFixed(1) || "N/A"} km</p>
      <p><strong>Wind Speed:</strong> {weather.wind?.speed === 0 ? "Calm" : `${weather.wind?.speed} m/s`} ({getWindDirection(weather.wind?.deg)})</p>
      <p><strong>Cloud Cover:</strong> {weather.clouds?.all || "N/A"}%</p>
      <p><strong>Sunrise:</strong> {new Date(weather.sys?.sunrise * 1000).toLocaleTimeString()}</p>
      <p><strong>Sunset:</strong> {new Date(weather.sys?.sunset * 1000).toLocaleTimeString()}</p>
    </>
  ) : (
    <p class="text-red-500">{errorMessage || "Unable to fetch weather data"}</p>
  )}
</div>
